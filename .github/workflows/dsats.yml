# ------------------------------------------------------------------------------
#  DAST - OWASP ZAP baseline scan (60 s) sur l'application d√©marr√©e en Docker
#  ‚Ä¢ Ne tourne que sur la branche par d√©faut (ici : main)
#  ‚Ä¢ L√®ve au plus le niveau PASS  (-l PASS)  ‚ûú n'√©choue pas sur les alertes
#  ‚Ä¢ Le job est ¬´ allow-failure ¬ª   (continue-on-error: true)
#  ‚Ä¢ Rapports JSON archiv√©s en artifact  zap-report
# ------------------------------------------------------------------------------

name: security-dast

on: [push]

permissions:
  contents: read
  security-events: write

jobs:
  zap-baseline:
    name: "OWASP ZAP ‚Äì baseline (60s)"
    runs-on: ubuntu-latest
    # üö¶ Le job NE bloque PAS la pipeline m√™me en cas d'erreur
    continue-on-error: true

    steps:
      # 1) R√©cup√©ration du code
      - uses: actions/checkout@v4

      # 2) Construction de l'image Docker de l'app
      - name: Build application image
        run: |
          docker build -t isen-python:latest .

      # 3) Lancement du conteneur en arri√®re-plan
      - name: Run application container
        run: |
          docker run -d --name classcapture \
            -p 8080:8080 isen-python:latest

      # 4) Attente que l'API r√©ponde
      - name: Wait until the app is up
        run: |
          for i in {1..24}; do
            if curl -sSf http://localhost:8080/ >/dev/null; then
              echo "‚úÖ App is up"
              exit 0
            fi
            echo "‚åõ Waiting for the app‚Ä¶"
            sleep 5
          done
          echo "‚ùå App did not start in time" >&2
          docker logs classcapture || true
          exit 1

      # 5) DAST : scan baseline 60 s, niveau alerte ¬´ PASS ¬ª
      - name: ZAP baseline scan (60s)
        uses: zaproxy/action-baseline@v0.9.0
        with:
          target: 'http://localhost:8080'
          # -t 60 : temps max de scan (s) ‚Äî baseline se limite d√©j√† aux tests l√©gers
          # -j    : g√©n√®re un rapport JSON
          # -l PASS : ne consid√®re que les alertes > PASS pour fixer le code de sortie
          # -I    : ignore les alertes INFO logu√©es par d√©faut
          cmd_options: '-t 60 -j -l PASS -I'

      # 6) Archivage du rapport JSON
      - name: Upload ZAP report
        if: always()                # on uploade m√™me si le scan √©choue
        uses: actions/upload-artifact@v4
        with:
          name: zap-report
          path: |
            **/*zap**.json
            **/*report*.json
